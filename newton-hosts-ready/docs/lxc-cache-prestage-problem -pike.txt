lxc- host failed due to  absense of unzip and lack of cleanup of old /tmp/rootfs.tar.xz


Scneriao : Async job for Ensure image has been pre-staged failed due to some network issue .

Download for /tmp/rootfs.tar.xz remained incomplete.  

The problem  aria image download async job failed to complete with 30 retry . After correcting the 
system date the problem was solved. However , the previous image might have remained . 

In the 2nd run  


1)Place container rootfs ,   unarchive:   module failed due to absense of unzip in centos 
2)Retrieve base image play could not import-tar /tmp/rootfs.tar.xz due to corrupt file at tmp .


Proposed solun:

1)Ensure unzip is present duing pkg install for centos 
2) Cleanup of old downloaded file / or checking file integrity  before retrieve base image





aria2c --max-connection-per-server=4 --continue --allow-overwrite=true --dir=/tmp --out=rootfs.tar.xz --check-certificate=true https://us.images.linuxcontainers.org/images/centos/7/amd64/default/20170922_02:16/rootfs.tar.xz https://uk.images.linuxcontainers.org/images/centos/7/amd64/default/20170922_02:16/rootfs.tar.xz  > /var/log/aria2c-image-prestage.log 2>&1

default/20170925_02:16/

https://us.images.linuxcontainers.org/images/centos/7/amd64/default/20170925_02:16/

Problem was in the index-system which was created on backdate 22nd, delete the index-system. set date correctly. and re run.




=======================

- name: Pre-stage the LXC image on the system

  shell: >

    aria2c

    --max-connection-per-server=4

    --continue

    --allow-overwrite=true

    --dir=/tmp

    --out=rootfs.tar.xz

    --check-certificate={{ (lxc_hosts_validate_certs | bool) | lower }}

    {% for server in lxc_image_cache_server_mirrors %}{{ server }}{{ item.split(';')[-1] }}rootfs.tar.xz {% endfor %}

    > /var/log/aria2c-image-prestage.log 2>&1

  args:

    warn: no

  register: prestage_image

  async: 300 # Here need var for  tiem adjustment

  poll: 0

  with_items:

    - "{{ lxc_images }}"

  tags:

    - skip_ansible_lint

    - always


==================================

- name: Ensure image has been pre-staged

  async_status:

    jid: "{{ item.ansible_job_id }}"

  register: job_result

  until: job_result.finished

  retries: 30  # here new variable to be introduced to adjust the retry 

  with_items:

    - "{{ prestage_image.results }}"

======================================

failed: [infra4] (item={'_ansible_parsed': True, 'changed': True, '_ansible_no_log': False, u'ansible_job_id': u'611988691184.3422', u'started': 1, '_ansible_item_result': True, 'item': u'centos;7;amd64;default;20170925_02:16;/images/centos/7/amd64/default/20170925_02:16/', u'finished': 0, u'results_file': u'/root/.ansible_async/611988691184.3422'}) => {
    "ansible_job_id": "611988691184.3422",
    "attempts": 30,
    "changed": false,
    "failed": true,
    "finished": 0,
    "invocation": {
        "module_args": {
            "jid": "611988691184.3422",
            "mode": "status"
        }
    },
    "item": {
        "ansible_job_id": "611988691184.3422",
        "changed": true,
        "finished": 0,
        "item": "centos;7;amd64;default;20170925_02:16;/images/centos/7/amd64/default/20170925_02:16/",
        "results_file": "/root/.ansible_async/611988691184.3422",
        "started": 1
    },
    "started": 1



changed: [infra4] => {
    "changed": true,
    "cmd": [
        "btrfs",
        "subvolume",
        "delete",
        "/var/lib/machines/centos-7-amd64"
    ],
    "delta": "0:00:00.006564",
    "end": "2017-09-25 12:53:12.156263",
    "failed": false,
    "failed_when_result": false,
    "invocation": {
        "module_args": {
            "_raw_params": "btrfs subvolume delete /var/lib/machines/centos-7-amd64",
            "_uses_shell": false,
            "chdir": null,
            "creates": null,
            "executable": null,
            "removes": null,
            "warn": true
        }
    },
    "rc": 0,
    "start": "2017-09-25 12:53:12.149699",
    "stderr": "",
    "stderr_lines": [],
    "stdout": "Delete subvolume (no-commit): '/var/lib/machines/centos-7-amd64'",
    "stdout_lines": [
        "Delete subvolume (no-commit): '/var/lib/machines/centos-7-amd64'"


