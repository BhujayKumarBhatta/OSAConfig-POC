Aodh related 
https://bugs.launchpad.net/openstack-ansible/+bug/1719875  for aodh returing 503 server not found . Haproxy misconfiguration.

https://etherpad.openstack.org/p/osa-telemetry-stack-fixing

https://review.openstack.org/#/c/512972/
         


Gnocchi
===============
when gnocchi metric list returns nothing and gnocchi access log shows 404 also ceilomehter-agent log shows 404 error as below

(ceilometer-16.0.4) root@infra1-ceilometer-central-container-4b6a8494:~# tail -f /var/log/ceilometer/ceilometer-agent-notification.log 

2017-12-08 09:38:29.325 2800 ERROR ceilometer.dispatcher.gnocchi [-] Error creating resource 0d5c6e8a-1d5b-45fb-af19-a2bc7cc7b              ecc: Resource type instance does not exist (HTTP 404): ResourceTypeNotFound: Resource type instance does not exist (HTTP 404)


In this case 

source /openstack/venvs/ceilometer-16.0.4/bin/activate

cat /etc/ceilometer/gnocchi_resources.yaml

ceilometer-upgrade –skip-metering-database



root@ansiblenew:/opt/openstack-ansible/playbooks# gnocchi metric  list
+--------------------------------------+---------------------+--------------------------------+-----------+---------------------------------         -----+
| id                                   | archive_policy/name | name                           | unit      | resource_id                                   |
+--------------------------------------+---------------------+--------------------------------+-----------+---------------------------------         -----+
| 001604b4-bdf1-4d5c-9130-5a87213a02dc | low                 | disk.allocation                | None      | d00c27f0-303f-4fc1-bfc9-18819a13         2d23 |
| 0038c358-6467-4348-a882-1002dd090788 | low                 | network.incoming.packets.rate  | packet/s  | 0e694db4-319c-5421-ac5b-c5408a16         15a0 |
| 003b4b6f-519a-4103-b254-db0911605ae0 | low                 | perf.cache.misses              | None      | 0d5c6e8a-1d5b-45fb-af19-a2bc7cc7         becc |
| 00d01d1d-142c-4d7a-864e-b4b1ec378a3b | low                 | memory                         | MB        | 5e707910-f164-44e5-81c5-d1e66186         902d |
| 0108e6aa-1604-4cd5-8986-2c75ba94c9cb | low                 | perf.cpu.cycles                | None      | d00c27f0-303f-4fc1-bfc9-18819a13         2d23 |
| 01c1fedc-38d1-427c-8cb4-1318f5ec4543 | low                 | compute.instance.booting.time  | None      | d00c27f0-303f-4fc1-bfc9-18819a13         2d23 |
| 02e32dc3-adb0-4a1c-86d4-60b6d4104741 | low                 | network.outgoing.packets.error | None      | c1333345-9f1b-5c1e-ad52-


Once a new servefr is created the agent log  shows 

2017-12-08 09:53:24.417 2800 ERROR ceilometer.dispatcher.gnocchi [-] Error creating resource 22511506-8232-4aff-8faf-0dc01f8e529a: Invalid i         nput: required key not provided @ data[u'host'] (HTTP 400): BadRequest: Invalid input: required key not provided @ data[u'host'] (HTTP 400)


however , the resource has been created  and  measures are showing 


root@ansiblenew:/opt/openstack-ansible/playbooks# gnocchi resource list | grep 22511506-8232-4aff-8faf-0dc01f8e529a
| 22511506-8232-4aff-8faf-0dc01f8e529a | instance                   | 373b270dc9a649d0b36671bdeec1e7e9 | 4a3c972a86564a4784bf4f0ba77b4b49 |          22511506-8232-4aff-8faf-0dc01f8e529a                                  | 2017-12-08T04:23:24.738276+00:00 | None     | 2017-12-08T04:23:24.73         8317+00:00 | None         | 0989ff0ef2954f50b8edb60dc9644bbd:88f85332ac8b43d7b125fda6915b741c |



root@ansiblenew:/opt/openstack-ansible/playbooks# gnocchi measures show --resource-id 22511506-8232-4aff-8faf-0dc01f8e529a cpu
+---------------------------+-------------+---------------+
| timestamp                 | granularity |         value |
+---------------------------+-------------+---------------+
| 2017-12-08T15:20:00+05:30 |       300.0 | 43228212160.0 |
+---------------------------+-------------+---------------+


To check that gnocchi is working ok we can do these steps manually

gnocchi metric create --archive-policy-name low  bhujay
root@ansiblenew:/opt/openstack-ansible/playbooks# gnocchi metric list
+--------------------------------------+---------------------+--------+------+-------------+
| id                                   | archive_policy/name | name   | unit | resource_id |
+--------------------------------------+---------------------+--------+------+-------------+
| 1b4ac0b6-8929-4a3a-a2be-f33d2e0152a1 | low                 | bhujay | None | None        |
+--------------------------------------+---------------------+--------+------+-------------+

gnocchi measures add -m 2017-12-07T16:49:00@01 -m 2017-12-07T16:50:00@02 -m 2017-12-07T16:49:00@02  1b4ac0b6-8929-4a3a-a2be-f33d2e0152a1
gnocchi measures show 1b4ac0b6-8929-4a3a-a2be-f33d2e0152a1
root@ansiblenew:/opt/openstack-ansible/playbooks# gnocchi measures show 1b4ac0b6-8929-4a3a-a2be-f33d2e0152a1
+---------------------------+-------------+-------+
| timestamp                 | granularity | value |
+---------------------------+-------------+-------+
| 2017-12-07T16:45:00+05:30 |       300.0 |   2.0 |
| 2017-12-07T16:50:00+05:30 |       300.0 |   2.0 |
+---------------------------+-------------+-------+


gnocchi measures show --aggregation 95pct  9cc8d20a-8475-4048-815a-0fd9d76cef00
gnocchi measures show --aggregation max  9cc8d20a-8475-4048-815a-0fd9d76cef00
gnocchi measures show --aggregation min  9cc8d20a-8475-4048-815a-0fd9d76cef00
Do not create resource type since this is already cerated for us during installation
gnocchi resource-type create --attribute name:string --attribute host:string server
gnocchi resource-type create --attribute name:string --attribute host:string instance

root@ansible:/opt/openstack-ansible/playbooks# openstack server list
+--------------------------------------+------+--------+-------------------------+------------+
| ID                                   | Name | Status | Networks                | Image Name |
+--------------------------------------+------+--------+-------------------------+------------+
| 63180470-5775-490d-9f96-5e7331c9c699 | v1   | ACTIVE | Provider-303=191.1.1.16 |            |
+--------------------------------------+------+--------+-------------------------+------------+
root@ansible:/opt/openstack-ansible/playbooks# gnocchi resource show 63180470-5775-490d-9f96-5e7331c9c699
Resource 63180470-5775-490d-9f96-5e7331c9c699 does not exist (HTTP 404)

This should have been created automatically by openstack - need to check why not and  who is responseible , probably ceilometer

add the new sever  manually 
gnocchi resource create   --attribute display_name:v1 --attribute host:kvm2 --attribute flavor_id:tiny --create-metric cpu:high --create-metric memory:high --type instance 63180470-5775-490d-9f96-5e7331c9c69
+-----------------------+----------------------------------------------+
| Field                 | Value                                        |
+-----------------------+----------------------------------------------+
| created_by_project_id | 81f17853ede54d7780307b94fa55c135             |
| created_by_user_id    | 84ef45b581364b979eb5302fe8f1e639             |
| display_name          | v1                                           |
| ended_at              | None                                         |
| flavor_id             | tiny                                         |
| host                  | kvm2                                         |
| id                    | 63180470-5775-490d-9f96-5e7331c9c699         |
| image_ref             | None                                         |
| metrics               | cpu: 651bf6bf-1c22-45b4-908f-b5f5f0ee93a6    |
|                       | memory: 86bf9560-c79d-4c42-a124-62295aa069b2 |
| original_resource_id  | 63180470-5775-490d-9f96-5e7331c9c699         |
| project_id            | None                                         |
| revision_end          | None                                         |
| revision_start        | 2017-05-13T15:56:05.738919+00:00             |
| server_group          | None                                         |
| started_at            | 2017-05-13T15:56:05.738851+00:00             |
| type                  | instance                                     |
| user_id               | None                                         |
+-----------------------+----------------------------------------------+


gnocchi resource update --attribute host:kvm2 --type instance 63180470-5775-490d-9f96-5e7331c9c699
+-----------------------+----------------------------------------------+
| Field                 | Value                                        |
+-----------------------+----------------------------------------------+
| created_by_project_id | 81f17853ede54d7780307b94fa55c135             |
| created_by_user_id    | 84ef45b581364b979eb5302fe8f1e639             |
| display_name          | v1                                           |
| ended_at              | None                                         |
| flavor_id             | tiny                                         |
| host                  | kvm2                                         |
| id                    | 63180470-5775-490d-9f96-5e7331c9c699         |
| image_ref             | None                                         |
| metrics               | cpu: 651bf6bf-1c22-45b4-908f-b5f5f0ee93a6    |
|                       | memory: 86bf9560-c79d-4c42-a124-62295aa069b2 |
| original_resource_id  | 63180470-5775-490d-9f96-5e7331c9c699         |
| project_id            | None                                         |
| revision_end          | None                                         |
| revision_start        | 2017-05-13T15:56:05.738919+00:00             |
| server_group          | None                                         |
| started_at            | 2017-05-13T15:56:05.738851+00:00             |
| type                  | instance                                     |
| user_id               | None                                         |
+-----------------------+----------------------------------------------+

root@ansible:/opt/openstack-ansible/playbooks# gnocchi resource history --format json --details 63180470-5775-490d-9f96-5e7331c9c699
[
  {
    "created_by_user_id": "84ef45b581364b979eb5302fe8f1e639", 
    "started_at": "2017-05-13T15:56:05.738851+00:00", 
    "user_id": null, 
    "revision_end": null, 
    "revision_start": "2017-05-13T15:56:05.738919+00:00", 
    "created_by_project_id": "81f17853ede54d7780307b94fa55c135", 
    "metrics": {
      "cpu": "651bf6bf-1c22-45b4-908f-b5f5f0ee93a6", 
      "memory": "86bf9560-c79d-4c42-a124-62295aa069b2"
    }, 
    "host": "kvm2", 
    "image_ref": null, 
    "flavor_id": "tiny", 
    "server_group": null, 
    "original_resource_id": "63180470-5775-490d-9f96-5e7331c9c699", 
    "ended_at": null, 
    "project_id": null, 
    "type": "instance", 
    "id": "63180470-5775-490d-9f96-5e7331c9c699", 
    "display_name": "v1"
  }

gnocchi measures add -m 2017-05-16T21:00:00@42 -m 2017-05-16T21:01:03@45 -m 2017-05-16T21:06:07@22 --resource-id 63180470-5775-490d-9f96-5e7331c9c699 cpu

gnocchi measures show --resource-id 63180470-5775-490d-9f96-5e7331c9c699 cpu

root@ansible:/opt/openstack-ansible/playbooks# gnocchi measures show 651bf6bf-1c22-45b4-908f-b5f5f0ee93a6

root@ansible:/opt/openstack-ansible/playbooks# gnocchi measures show --resource-id 63180470-5775-490d-9f96-5e7331c9c699 cpu
+---------------------------+-------------+---------------+
| timestamp                 | granularity |         value |
+---------------------------+-------------+---------------+
| 2017-05-16T21:00:00+00:00 |      3600.0 | 36.3333333333 |
| 2017-05-16T21:00:00+00:00 |        60.0 |          42.0 |
| 2017-05-16T21:01:00+00:00 |        60.0 |          45.0 |
| 2017-05-16T21:06:00+00:00 |        60.0 |          22.0 |
| 2017-05-16T21:00:00+00:00 |         1.0 |          42.0 |
| 2017-05-16T21:01:03+00:00 |         1.0 |          45.0 |
| 2017-05-16T21:06:07+00:00 |         1.0 |          22.0 |
+---------------------------+-------------+---------------+

gnocchi resource search --type instance host=kvm2


============================


Openstack-ansible version 16.0.4  , pike  . 

Operating system : Ubuntu Xenial 16.04

Gnocchi backend storage : ceph , rbd 

Multi node set up with  two haproxy , three controllers on pod1 , one kvm and  one separate newtron on pod2 

ceilometer was deployed only on controller1 and gnocchi was installed in controller 3  

Problem :  after installation is over I  ran  'gnocchi metric list'  and it returns nothing
Checked the log in ceilometer agent and it shows 
(ceilometer-16.0.4) root@infra1-ceilometer-central-container-4b6a8494:~# tail -f /var/log/ceilometer/ceilometer-agent-notification.log 
2017-12-08 09:38:29.325 2800 ERROR ceilometer.dispatcher.gnocchi [-] Error creating resource 0d5c6e8a-1d5b-45fb-af19-a2bc7cc7b              ecc: Resource type instance does not exist (HTTP 404): ResourceTypeNotFound: Resource type instance does not exist (HTTP 404)

Solution: 

on the ceilometer-central-container run ceilometer-upgrade --skip-metering-database to create the resources in gnocchi . This is as per the installation document https://docs.openstack.org/ceilometer/pike/contributor/install/manual.html

Result :

Immediately after running ceilometer-upgrade we can observer from gnocchi-access.log that resources are getting posted 
now running metric list we  can see all the resources 

root@ansiblenew:/opt/openstack-ansible/playbooks# gnocchi metric  list
+--------------------------------------+---------------------+--------------------------------+-----------+---------------------------------         -----+
| id                                   | archive_policy/name | name                           | unit      | resource_id                                   |
+--------------------------------------+---------------------+--------------------------------+-----------+---------------------------------         -----+
| 001604b4-bdf1-4d5c-9130-5a87213a02dc | low                 | disk.allocation                | None      | d00c27f0-303f-4fc1-bfc9-18819a13         2d23 |
| 0038c358-6467-4348-a882-1002dd090788 | low                 | network.incoming.packets.rate  | packet/s  | 0e694db4-319c-5421-ac5b-c5408a16         15a0 |
| 003b4b6f-519a-4103-b254-db0911605ae0 | low                 | perf.cache.misses              | None      | 0d5c6e8a-1d5b-45fb-af19-a2bc7cc7         becc |
| 00d01d1d-142c-4d7a-864e-b4b1ec378a3b | low                 | memory                         | MB        | 5e707910-f164-44e5-81c5-d1e66186         902d |
| 0108e6aa-1604-4cd5-8986-2c75ba94c9cb | low                 | perf.cpu.cycles                | None      | d00c27f0-303f-4fc1-bfc9-18819a13         2d23 |
| 01c1fedc-38d1-427c-8cb4-1318f5ec4543 | low                 | compute.instance.booting.time  | None      | d00c27f0-303f-4fc1-bfc9-18819a13         2d23 |
| 02e32dc3-adb0-4a1c-86d4-60b6d4104741 | low                 | network.outgoing.packets.error | None      | c1333345-9f1b-5c1e-ad52-


I am filing a pull request soon to include this step in gnocchi role . 
https://bugs.launchpad.net/openstack-ansible/+bug/1737096


root@ansiblenew:/etc/ansible/roles/os_ceilometer/tasks# vi ceilometer_post_install.yml

- name: check for gnocchi resource file
  stat:
    path: "/etc/ceilometer/gnocchi_resources.yaml"
  register: gnocchi_resource_file

- name: Initialize Gnocchi database by creating ceilometer resources
  command: "{{ ceilometer_bin }}/ceilometer-upgrade --skip-metering-database"
  become: yes
  become_user: "{{ ceilometer_system_user_name }}"
  changed_when: false
  when: gnocchi_resource_file.stat.exists



TASK [os_ceilometer : check for gnocchi resource file] ********************************************************************
task path: /etc/ansible/roles/os_ceilometer/tasks/ceilometer_post_install.yml:98
Friday 08 December 2017  15:58:11 +0530 (0:00:02.533)       0:02:52.935 *******
ok: [kvm1] => {"changed": false, "stat": {"atime": 1512748399.428898, "attr_flags": "e", "attributes": ["extents"], "block_                          size": 4096, "blocks": 24, "charset": "us-ascii", "checksum": "c61e5603967361560c61da6f33d688a115f7ff4c", "ctime": 15126532                          30.7964942, "dev": 64512, "device_type": 0, "executable": false, "exists": true, "gid": 997, "gr_name": "ceilometer", "inod                          e": 2359562, "isblk": false, "ischr": false, "isdir": false, "isfifo": false, "isgid": false, "islnk": false, "isreg": true                          , "issock": false, "isuid": false, "md5": "181a8b645db996011295f7412f5b58df", "mimetype": "text/plain", "mode": "0644", "mt                          ime": 1512653230.5364847, "nlink": 1, "path": "/etc/ceilometer/gnocchi_resources.yaml", "pw_name": "ceilometer", "readable"                          : true, "rgrp": true, "roth": true, "rusr": true, "size": 8977, "uid": 997, "version": "18446744071985389687", "wgrp": fals                          e, "woth": false, "writeable": true, "wusr": true, "xgrp": false, "xoth": false, "xusr": false}}
ok: [infra1_ceilometer_central_container-4b6a8494] => {"changed": false, "stat": {"atime": 1512647787.2659726, "attr_flags"                          : "e", "attributes": ["extents"], "block_size": 4096, "blocks": 24, "charset": "us-ascii", "checksum": "c61e5603967361560c6                          1da6f33d688a115f7ff4c", "ctime": 1512647652.1467304, "dev": 64512, "device_type": 0, "executable": false, "exists": true, "                          gid": 999, "gr_name": "ceilometer", "inode": 4344742, "isblk": false, "ischr": false, "isdir": false, "isfifo": false, "isg                          id": false, "islnk": false, "isreg": true, "issock": false, "isuid": false, "md5": "181a8b645db996011295f7412f5b58df", "mim                          etype": "text/plain", "mode": "0644", "mtime": 1512647651.8267226, "nlink": 1, "path": "/etc/ceilometer/gnocchi_resources.y                          aml", "pw_name": "ceilometer", "readable": true, "rgrp": true, "roth": true, "rusr": true, "size": 8977, "uid": 999, "versi                          on": "512509023", "wgrp": false, "woth": false, "writeable": true, "wusr": true, "xgrp": false, "xoth": false, "xusr": fals                          e}}

TASK [os_ceilometer : Initialize Gnocchi database by creating ceilometer resources] ***************************************
task path: /etc/ansible/roles/os_ceilometer/tasks/ceilometer_post_install.yml:103
Friday 08 December 2017  15:58:13 +0530 (0:00:02.036)       0:02:54.972 *******
ok: [kvm1] => {"changed": false, "cmd": ["/openstack/venvs/ceilometer-16.0.4/bin/ceilometer-upgrade", "--skip-metering-data                          base"], "delta": "0:00:13.432301", "end": "2017-12-08 21:23:44.975117", "rc": 0, "start": "2017-12-08 21:23:31.542816", "st                          derr": "", "stderr_lines": [], "stdout": "2017-12-08 21:23:39.924 9206 WARNING oslo_reports.guru_meditation_report [-] Guru                           meditation now registers SIGUSR1 and SIGUSR2 by default for backward compatibility. SIGUSR1 will no longer be registered i                          n a future release, so please use SIGUSR2 to generate reports.\n2017-12-08 21:23:39.925 9206 INFO ceilometer.cmd.storage [-                          ] Skipping metering database upgrade\n2017-12-08 21:23:41.149 9206 WARNING oslo_config.cfg [-] Option \"os_endpoint_type\"                           from group \"service_credentials\" is deprecated. Use option \"interface\" from group \"service_credentials\".", "stdout_li                          nes": ["2017-12-08 21:23:39.924 9206 WARNING oslo_reports.guru_meditation_report [-] Guru meditation now registers SIGUSR1                           and SIGUSR2 by default for backward compatibility. SIGUSR1 will no longer be registered in a future release, so please use                           SIGUSR2 to generate reports.", "2017-12-08 21:23:39.925 9206 INFO ceilometer.cmd.storage [-] Skipping metering database upg                          rade", "2017-12-08 21:23:41.149 9206 WARNING oslo_config.cfg [-] Option \"os_endpoint_type\" from group \"service_credentia                          ls\" is deprecated. Use option \"interface\" from group \"service_credentials\"."]}
ok: [infra1_ceilometer_central_container-4b6a8494] => {"changed": false, "cmd": ["/openstack/venvs/ceilometer-16.0.4/bin/ce                          ilometer-upgrade", "--skip-metering-database"], "delta": "0:00:18.444517", "end": "2017-12-08 15:58:33.494740", "rc": 0, "s                          tart": "2017-12-08 15:58:15.050223", "stderr": "", "stderr_lines": [], "stdout": "2017-12-08 15:58:24.810 8727 WARNING oslo                          _reports.guru_meditation_report [-] Guru meditation now registers SIGUSR1 and SIGUSR2 by default for backward compatibility                          . SIGUSR1 will no longer be registered in a future release, so please use SIGUSR2 to generate reports.\n2017-12-08 15:58:24                          .812 8727 INFO ceilometer.cmd.storage [-] Skipping metering database upgrade\n2017-12-08 15:58:27.198 8727 WARNING oslo_con                          fig.cfg [-] Option \"os_endpoint_type\" from group \"service_credentials\" is deprecated. Use option \"interface\" from gro                          up \"service_credentials\".", "stdout_lines": ["2017-12-08 15:58:24.810 8727 WARNING oslo_reports.guru_meditation_report [-                          ] Guru meditation now registers SIGUSR1 and SIGUSR2 by default for backward compatibility. SIGUSR1 will no longer be regist                          ered in a future release, so please use SIGUSR2 to generate reports.", "2017-12-08 15:58:24.812 8727 INFO ceilometer.cmd.st                          orage [-] Skipping metering database upgrade", "2017-12-08 15:58:27.198 8727 WARNING oslo_config.cfg [-] Option \"os_endpoi                          nt_type\" from group \"service_credentials\" is deprecated. Use option \"interface\" from group \"service_credentials\"."]}


Run ceilometer-upgrade task  post ceiloemeter installation
to create the resources in gnocchi'


Closes-Bug:: 1737096

Done

Participants:
     name -irc nick bhujay
     Working on :  https://review.openstack.org/526655
     https://bugs.launchpad.net/openstack-ansible/+bug/1737096
     
     Does it seem more logical  to install  gnocchi before ceilometer  in  setup-openstack.yml ?  Without this ceilometer-agent log shows error  while trying to connect to gnocchi database .  After installation is completed often I found gnocchi metric list returns nothing. While the above patch set proposed is one of the reason , the order of installation cloud be still contribute to this . 

