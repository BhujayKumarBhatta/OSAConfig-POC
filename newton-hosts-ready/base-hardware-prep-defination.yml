# include the host name in inventory-base-hw-prep and run with -i option as below
# ansible-playbook base-hw-prep.yml  -i inventory-base-hw-prep



servers_to_reboot:
#  - infra1
#  - infra2
#  - infra3
  - kvm1
  - kvm2
#  - bm1
#  - haproxy1
#  - rsyslog
#  - haproxy2 
#  - haproxy2 

#################################################################################
# network interface defination - 
# leave bonded_with: empty  if insted of bond physical interface is wanted
# more interface can be added to a bond , add interface and associate them with bond and leave the bond_primary: blank
# vNic or subinterfaces can be created from interfaces or bond just by giving appropriate vNicName and vNicParent
# to run the network configuration role only run 
#ansible-playbook -i inventory-base-hw-prep base-hw-prep.yml  --tags configure-network
#multiple dns entries to be enterted with a space ex dns: 115.112.18.21 115.112.18.131

target_hosts:
 haproxy1:
   hostname: haproxy1 
   ssh_ip: 10.0.0.51
   roles:
     - haproxy
     - squidproxy
     - ntpmaster
     - firewall 
   change_network_interface_file: True
   nic: 
     - {nicName: eno1,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface eno1 , part of bond1 }
     - {nicName: eno2,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: eno1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC eno1 }  
     - {bondName: bond2, bondNic: eno2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC eno2 }             
   vNic: 
     - {vNicName: , vNicParent: , address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description:  } 
               
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.51 ,netmask: 255.255.255.0 ,network: 10.0.0.0,
        broadcast: 10.0.0.255,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-internet,brPort: bond2, address: 14.142.104.139 ,netmask: 255.255.255.248 ,network: 14.142.104.136, 
         broadcast: 14.142.104.143, gateway: 14.142.104.137,dns: 115.112.18.21 115.112.18.131,part_of_vlan: True,
             description: USed for internet connection }
   Firewall:
    internet_facing_interface: br-internet
    internal_interface: br-mgmt 
    default_rules:     
     - { interface: br-internet, defaultin: deny, defaultout: allow}
     - { interface: br-mgmt, defaultin: allow, defaultout: allow}
            
    specific_rules:      
      - {interface: br-internet,direction: out,from: any, to: any , protocol: tcp, 
          ports: [http, https, 2223, 6080, 6080, 6081, 6082], action: allow}
      - {interface: br-internet,direction: in, from: any, to: any , protocol: tcp,
           ports: [http, https, 2223, 6080, 6080, 6081, 6082], action: allow}
      - {interface: br-internet,direction: out,from: any, to: any ,
          protocol: udp, ports: [123,], action: allow}
      - {interface: br-internet,direction: in,from: any, to: any ,
           protocol: udp, ports: [123,], action: allow}
#---------------------------------------------------------------------------------------------------
 haproxy2:
   hostname: haproxy2 
   ssh_ip: 10.0.0.52
   roles:
     - haproxy
     - squidproxy
     - ntpmaster
     - firewall
   change_network_interface_file: True
   nic:
     - {nicName: enp5s0,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface enp5s0 , part of bond1 }
     - {nicName: enp9s0,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}
   bond:
     - {bondName: bond1, bondNic: enp5s0, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: bond 1 using NIC enp5s0 }
     - {bondName: bond2, bondNic: enp9s0, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: bond 2 using NIC enp9s0 }
   vNic:
     - {vNicName: , vNicParent: , address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description:  }

   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.52 ,netmask: 255.255.255.0 ,network: 10.0.0.0,
        broadcast: 10.0.0.255,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-internet,brPort: bond2, address: 14.142.104.138 ,netmask: 255.255.255.248 ,network: 14.142.104.136, 
         broadcast: 14.142.104.143, gateway: 14.142.104.137,dns: 115.112.18.21 115.112.18.131,part_of_vlan: True,
             description: USed for internet connection }
   Firewall:
    internet_facing_interface: br-internet
    internal_interface: br-mgmt
    default_rules:
     - { interface: br-internet, defaultin: deny, defaultout: allow}
     - { interface: br-mgmt, defaultin: allow, defaultout: allow}

    specific_rules:
      - {interface: br-internet,direction: out,from: any, to: any , protocol: tcp,}
  
 #--------------------------------------------------------------------------------------------------------------- 
 
 infra1: 
   hostname: infra1
   ssh_ip: 10.0.0.21
   roles: controller
   change_network_interface_file: True
   nic: 
     - {nicName: eno1,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface eno1 , part of bond1 }
     - {nicName: eno2,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: eno1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC eno1 }  
     - {bondName: bond2, bondNic: eno2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC eno2 }             
   vNic:
     - {vNicName: bond1.10, vNicParent: bond1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: used by br-storage bridge } 
     - {vNicName: bond2.20,vNicParent: bond2, address: ,netmask: ,network: ,broadcast:  ,gateway: ,dns: , 
             description: used by br-vxlan bridge}            
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.21 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-storage,brPort: bond1.10, address: 10.0.2.21 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Storage }
     - {brName: br-vlan,brPort: bond2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Provider Network flat or vlan , To be connected to external router gateway.Bridge will not have any IP}
     - {brName: br-vxlan,brPort: bond2.20, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True, 
             description: Used for tenant network , virtual network. On Controller this bridge will not have address}
#---------------------------------------------------------------------------------------------------------------------------------
 infra2:
   hostname: infra2
   ssh_ip: 10.0.0.22
   roles: controller
   change_network_interface_file: True
   nic: 
     - {nicName: eno1,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface eno1 , part of bond1 }
     - {nicName: eno2,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: eno1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC eno1 }  
     - {bondName: bond2, bondNic: eno2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC eno2 }             
   vNic:
     - {vNicName: bond1.10, vNicParent: bond1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: used by br-storage bridge } 
     - {vNicName: bond2.20,vNicParent: bond2, address: ,netmask: ,network: ,broadcast:  ,gateway: ,dns: , 
             description: used by br-vxlan bridge}            
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.22 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-storage,brPort: bond1.10, address: 10.0.2.22 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Storage }
     - {brName: br-vlan,brPort: bond2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Provider Network flat or vlan , To be connected to external router gateway.Bridge will not have any IP}
     - {brName: br-vxlan,brPort: bond2.20, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True, 
             description: Used for tenant network , virtual network. On Controller this bridge will not have address}
#-----------------------------------------------------------------------------------------------------------------
 infra3:
   hostname: infra3
   ssh_ip: 10.0.0.23
   roles: controller
   change_network_interface_file: True
   nic: 
     - {nicName: eno1,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface eno1 , part of bond1 }
     - {nicName: eno2,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: eno1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC eno1 }  
     - {bondName: bond2, bondNic: eno2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC eno2 }             
   vNic:
     - {vNicName: bond1.10, vNicParent: bond1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: used by br-storage bridge } 
     - {vNicName: bond2.20,vNicParent: bond2, address: ,netmask: ,network: ,broadcast:  ,gateway: ,dns: , 
             description: used by br-vxlan bridge}            
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.23 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-storage,brPort: bond1.10, address: 10.0.2.23 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Storage }
     - {brName: br-vlan,brPort: bond2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Provider Network flat or vlan , To be connected to external router gateway.Bridge will not have any IP}
     - {brName: br-vxlan,brPort: bond2.20, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True, 
             description: Used for tenant network , virtual network. On Controller this bridge will not have address}
#------------------------------------------------------------------------------------------------------------------
 kvm1:
   hostname: kvm1
   ssh_ip: 10.0.0.31
   roles: novacompute
   change_network_interface_file: True
   nic: 
     - {nicName: eno1,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface eno1 , part of bond1 }
     - {nicName: eno2,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: eno1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC eno1 }  
     - {bondName: bond2, bondNic: eno2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC eno2 }             
   vNic:
     - {vNicName: bond1.10, vNicParent: bond1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: used by br-storage bridge } 
     - {vNicName: bond2.20,vNicParent: bond2, address: ,netmask: ,network: ,broadcast:  ,gateway: ,dns: , 
             description: used by br-vxlan bridge}            
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.31 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-storage,brPort: bond1.10, address: 10.0.2.31 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Storage }
     - {brName: br-vlan,brPort: bond2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Provider Network flat or vlan , To be connected to external router gateway. Bridge doesn't have any IP}
     - {brName: br-vxlan,brPort: bond2.20, address: 10.0.1.31 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True, 
             description: Used for tenant network , virtual network. On Compute node this will have address}   
#-------------------------------------------------------------------------------------------------------------------   
 kvm2:
   hostname: kvm2
   ssh_ip: 10.0.0.32
   roles: novacompute
   change_network_interface_file: True
   nic: 
     - {nicName: eno1,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface eno1 , part of bond1 }
     - {nicName: eno2,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: eno1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC eno1 }  
     - {bondName: bond2, bondNic: eno2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC eno2 }             
   vNic:
     - {vNicName: bond1.10, vNicParent: bond1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: used by br-storage bridge } 
     - {vNicName: bond2.20,vNicParent: bond2, address: ,netmask: ,network: ,broadcast:  ,gateway: ,dns: , 
             description: used by br-vxlan bridge}            
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.32 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-storage,brPort: bond1.10, address: 10.0.2.32 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Storage }
     - {brName: br-vlan,brPort: bond2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Provider Network flat or vlan , To be connected to external router gateway. Bridge doesn't have any IP}
     - {brName: br-vxlan,brPort: bond2.20, address: 10.0.1.32 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True, 
             description: Used for tenant network , virtual network. On Compute node this will have address}    
#----------------------------------------------------------------------------------------------------------------  
 
 bm1:
   hostname: bm1
   ssh_ip: 10.0.0.42
   roles: novacompute
   change_network_interface_file: True
   nic: 
     - {nicName: eno1,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface eno1 , part of bond1 }
     - {nicName: eno2,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: eno1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC eno1 }  
     - {bondName: bond2, bondNic: eno2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC eno2 }             
   vNic:
     - {vNicName: bond1.10, vNicParent: bond1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: used by br-storage bridge } 
     - {vNicName: bond2.20,vNicParent: bond2, address: ,netmask: ,network: ,broadcast:  ,gateway: ,dns: , 
             description: used by br-vxlan bridge}            
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.42 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-storage,brPort: bond1.10, address: 10.0.2.42 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Storage }
     - {brName: br-vlan,brPort: bond2, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Provider Network flat or vlan , To be connected to external router gateway. Bridge doesn't have any IP}
     - {brName: br-vxlan,brPort: bond2.20, address: 10.0.1.42 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True, 
             description: Used for tenant network , virtual network. On Compute node this will have address}   
#------------------------------------------------------------------------------------------------------------------   
 rsyslog1:
   hostname: rsyslog
   ssh_ip: 10.0.0.57
   roles: rsyslog
   change_network_interface_file: True
   nic: 
     - {nicName: enp3s0,bonded_with: bond1 ,  bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface enp3s0 , part of bond1 }
     - {nicName: enp6s0,bonded_with: bond2,bond_primary: True, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: physical interface part of bond 2 connected to switch ....}                  
   bond: 
     - {bondName: bond1, bondNic: enp3s0, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 1 using NIC enp3s0 }  
     - {bondName: bond2, bondNic: enp6s0, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: , 
             description: bond 2 using NIC enp6s0 }             
   vNic:
     - {vNicName: bond1.10, vNicParent: bond1, address: ,netmask: ,network: ,broadcast: ,gateway: ,dns: ,
             description: used by br-storage bridge } 
     - {vNicName: bond2.20,vNicParent: bond2, address: ,netmask: ,network: ,broadcast:  ,gateway: ,dns: , 
             description: used by br-vxlan bridge}            
   bridges: 
     - {brName: br-mgmt,brPort: bond1, address: 10.0.0.57 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Managment, SSH and api access }
     - {brName: br-storage,brPort: bond1.10, address: 10.0.2.57 ,netmask: 255.255.255.0 ,network: ,broadcast: ,gateway: ,dns: ,part_of_vlan: True,
             description: USed for Openstack Storage }
     
############################################################################################

#Proxy and apt configuration 

####################################################################################################
host_table_entry: |
        10.0.0.52        haproxy2
        10.0.0.51        haproxy1
# use keepalived virtual ip to avoid dependency on one proxy server ip 
etc_environment_entry: |
        export https_proxy="http://10.0.0.14:3128"
        export http_proxy="http://10.0.0.14:3128"
        no_proxy=localhost,127.0.0.1,10.*.*.*,*.poc,10.0.0.51,10.0.0.52,10.0.0.53,gitlab
apt_proxy_entry: |
        Acquire::http { Proxy "http://10.0.0.14:3128";};
        Acquire::https { Proxy "http://10.0.0.14:3128";};        
pip_proxy_entry: |
        [global]
        proxy = 10.0.0.14:3128
     

############################################################## 

Chrony_clients_uplink_names: |
  server 10.0.0.51
  server 10.0.0.52
  
nfs_share_names:
  - /images



base_apt_packages:
 - python
 - bridge-utils
 - vlan 
 - debootstrap
 - ifenslave 
 - ifenslave-2.6 
 - lsof 
 - lvm2  
 - openssh-server 
 - sudo 
 - tcpdump 
#####################################################



 

 
